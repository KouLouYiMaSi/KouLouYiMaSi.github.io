<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Atlassian插件开发</title>

		<link rel="stylesheet" href="reveal/css/reveal.css">
		<link rel="stylesheet" href="reveal/css/theme/black.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="reveal/lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'reveal/css/print/pdf.css' : 'reveal/css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
				    <h3>Jira/Confluence插件系统探析</h3>
					<div align="right"><p><font color="CFB53B" size="6">——从OpenId到OSGi，开发你的专属插件</font></p></div>
				</section>
				<section data-markdown data-separator="---" data-separator-vertical="--">
					<script type="text/template">
						## 主要内容
						* <p class="fragment" data-fragment-index="1">[Atlassian插件开发流程](mds/atlassianprocess.html)</p>
						* <p class="fragment" data-fragment-index="2"><a href="#" class="navigate-right">OpenId认证流程<a></p>
						* <p class="fragment" data-fragment-index="3">OpenId插件开发</p>
						* <p class="fragment" data-fragment-index="4">Atlassian插件系统原理浅析</p>
						--
						### Component Import作用：
						* 依赖系统里的一些服务（类），如XXXManager
						* 依赖其他插件的相关服务（类）
						```
						<component-import key="userManager" interface="com.atlassian.sal.api.user.UserManager"/>
						<component-import key="helloWorldService">
							<interface>com.myapp.HelloWorldService</interface>
						</component-import>
						```
						--
						### Component作用
						* 声明一个服务
						> component在插件运行的时候会自动转换成Spring中的bean
						```
						<component key="helloWorldService" class="com.myapp.internal.MyHelloWorldService" public="true">
							<interface>com.myapp.HelloWorldService</interface>
						</component>
						```
						--
						### servlet相关Module
						```
						    <servlet name="Hello World Servlet" key="helloWorld" class="com.example.myplugins.helloworld.HelloWorldServlet">
								<description>Says Hello World, Australia or your name.</description>
								<url-pattern>/helloworld</url-pattern>
								<init-param>
								<param-name>defaultName</param-name>
							<param-value>Australia</param-value>
							</init-param>
							</servlet>
						```
						--
						### Spring相关Module
						* 方式一：配置方式与Component一致
						* 方式二：在META_INF/spring/*.xml中配置bean标签
						* 方式三：使用注解
						--
						### Xwork Module
						```
						<xwork name="livesearchaction" key="livesearchaction">
							<package name="livesearch" extends="default" namespace="/plugins/livesearch">
							<default-interceptor-ref name="defaultStack" />
							<action name="livesearch"
								class="com.atlassian.confluence.extra.livesearch.LiveSearchAction">
								<result name="success" type="velocity">/templates/extra/livesearch/livesearchaction.vm</result>
							</action>
							</package>
						</xwork>
						```
						- 在java类里面继承ConfluenceActionSupport类
						- 访问的时候把vm换成action
						> [Go On](mds/atlassianprocess.html#/step-12)
					</script>
				</section>
				<section data-transition="zoom" data-markdown data-separator="---" data-separator-vertical="--">
						<script type="text/template">
						### [OpenId认证流程](mds/openidvalid.html)
						- <p class="fragment fade-up" data-fragment-index="2">用户访问应用，应用服务器携带一些参数把请求重定向到OpenId服务器</p>
						- <p class="fragment fade-right" data-fragment-index="3">OpenId服务器对用户名密码进行鉴权</p>
						- <p class="fragment fade-left" data-fragment-index="4">成功之后跳转到配置好的应用服务器，并携带一些参数</p>
						- <p class="fragment fade-up" data-fragment-index="5">应用服务器Openid服务器请求token等参数</p>
						- <p class="fragment fade-right" data-fragment-index="6">应用服务器对OpenId返回的参数进行解密并验证</p>
						- <p class="fragment fade-left" data-fragment-index="7">应用服务器获取用户相关信息，至此，结束</p>
						--
						![](image/openidflow.png)
						</script>
				</section>
				<section data-transition="zoom" data-markdown data-separator="---" data-separator-vertical="--">
						<script type="text/template">
							### OpenId插件开发关键步骤
							* Openid认证流程系列步骤
							* Confluence登录认证流程
							--
							### Confluence登录认证流程
							* <p class="fragment fade-up" data-fragment-index="1">首先查询系统里是否有该邮箱的用户</p>
							* <p class="fragment fade-up" data-fragment-index="2">如果没有就创建一个，密码为Confluence安全生成的随机密码，设置session跳转到主页</p>
							* <p class="fragment fade-up" data-fragment-index="3">如果有就把session设置成登录状态，直接跳转到主页</p>
						</script>
				</section>
				<section data-transition="zoom" data-markdown data-separator="---" data-separator-vertical="--">
						<script type="text/template">
							## Atlassian插件系统原理浅析
							* Atlassian插件系统基于Apache Felix的OSGi服务
							--
							### 什么是OSGi？
							+ <p class="fragment fade-up" data-fragment-index="1">Java动态化模块化系统的一系列规范</p>
							--
							### OSGi有什么用？
							+ <p class="fragment fade-up" data-fragment-index="1">将服务模块化，面向对象转变为面向服务</p>
							+ <p class="fragment fade-up" data-fragment-index="2">更好的控制模块之间的依赖</p>
							+ <p class="fragment fade-up" data-fragment-index="3">更快的启动系统，提高系统可用性</p>
							+ <p class="fragment fade-up" data-fragment-index="4">支持模块热插拔，即插即用</p>
							--
							#### OSGi服务模型
							![](image/osgiFrame.png)
							--
							<p>实际上Atlassian的插件本质上就是OSGI服务的bundle，用标准模式开发的bundle可以直接跑在JIra系统上，atlassian-plugin.xml文件会被翻译成manifest.mf文件</p>
							--
							### Eclipse里搭建Apache Felix环境
							* <p class="fragment fade-up" data-fragment-index="1">官网下载OSGi服务框架Apache Felix</p>
							* <p class="fragment fade-up" data-fragment-index="2">Eclipse新建Java Project，拷贝bundle和conf文件到工程里</p>
							* <p class="fragment fade-up" data-fragment-index="3">引入bin目录下的felix.jar文件（里面含有main方法）</p>
							* <p class="fragment fade-up" data-fragment-index="4">创建一个存放自己插件的文件夹plugins</p>
							--
							* 配置启动方式，Run Configurations;Java Application;new
							![](image/runconf.png)
							--
							#### 在eclipse里开发bundle
							![](image/plug-in.png)
							--
							* Activator控制插件的生命周期，类似于Servlet的生命周期
							* start/stop方法用于启动和停止插件，可热插拔
							* BundleContext用于代码与框架进行交互（也是唯一的交互方式）
							--
							* <p class="fragment fade-up" data-fragment-index="1">开发完成通过export；Deployable plug-ins and fragments发布到plugins文件夹</p>
							* <p class="fragment fade-up" data-fragment-index="2">执行安装插件命令install file:plugins/XXX.jar</p>
							* <p class="fragment fade-up" data-fragment-index="3">start bundle id启动该插件</p>
							* <p class="fragment fade-up" data-fragment-index="4">插件之间的依赖是通过manifest里面的export-package和import-package暴露和导入的</p>
						</script>
				</section>
				<section>
					<h2>Q & A </h2>
				</section>
			</div>
		</div>
			</div>
		</div>

		<script src="reveal/lib/js/head.min.js"></script>
		<script src="reveal/js/reveal.js"></script>

		<script>
			Reveal.initialize({
				dependencies: [
					{ src: 'reveal/plugin/markdown/marked.js' },
					{ src: 'reveal/plugin/markdown/markdown.js' },
					{ src: 'reveal/plugin/notes/notes.js', async: true },
					{ src: 'reveal/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
